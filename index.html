<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <title>Calculadora M√°gica Optimizada</title>

    <!-- Librer√≠as JS - Versiones espec√≠ficas para compatibilidad -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- QZ-Tray para impresi√≥n t√©rmica ESC/POS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qz-tray/2.1.0/qz-tray.js"></script>

    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="copyright-icon" onclick="toggleCopyrightNotice()">¬©</div>
    <div class="copyright-notice" id="copyrightNotice">
        <button class="close-btn" onclick="toggleCopyrightNotice()">√ó</button>
        <strong>ADVERTENCIA:</strong> Este sistema est√° protegido por derechos de autor.
        <strong>No revendas tu c√≥digo de acceso</strong> o ser√° bloqueado y perder√°s tu dinero.
        Cualquier uso no autorizado ser√° penalizado seg√∫n las leyes aplicables.
    </div>

    <div class="calculator">
        <h2>Calculadora M√°gica Optimizada</h2>

        <!-- Secci√≥n para respaldo/restauraci√≥n de datos y limpieza -->
        <section>
            <h3>Mantenimiento y Respaldo</h3>
            <button onclick="descargarBackup()" class="backup-button">üì• Descargar Respaldo</button>
            <button onclick="document.getElementById('fileInput').click()" class="restore-button">üì§ Cargar Respaldo</button>
            <input type="file" id="fileInput" accept=".json" style="display: none" onchange="cargarBackup(this.files)" />
            <button onclick="limpiarDatosViejos()" class="cleanup-button">üßπ Limpiar Datos Antiguos</button>
            <small style="display:block; color:#666;">Elimina ventas de m√°s de 30 d√≠as para liberar espacio.</small>
        </section>

        <section>
            <h3>Nombre del Establecimiento</h3>
            <input type="text" id="nombreEstablecimiento" placeholder="Ej: Tienda La Bendici√≥n" />
            <button onclick="guardarNombreEstablecimiento()">Guardar Nombre</button>
        </section>

        <section>
            <h3>Gesti√≥n de Clave de Seguridad</h3>
            <button onclick="mostrarModalCambiarClave()" class="backup-button">Cambiar Clave de Seguridad</button>
        </section>

        <section>
            <h3>Tasa BCV</h3>
            <input type="number" id="tasaBCV" placeholder="Tasa BCV" step="any" required />
            <button onclick="actualizarTasaBCV()">Actualizar Tasa BCV</button>
        </section>

        <section>
            <h3>Datos del Producto</h3>
            <input type="text" id="producto" placeholder="Nombre del producto" required />
            <input type="text" id="codigoBarras" placeholder="C√≥digo de barras (opcional)" />
            <input type="number" id="costo" placeholder="Costo del producto (en $)" step="any" required />
            <select id="descripcion" required>
                <option value="">Selecciona una descripci√≥n</option>
                <option value="viveres">V√≠veres</option>
                <option value="bebidas">Bebidas</option>
                <option value="licores">Licores</option>
                <option value="enlatados">Enlatados</option>
                <option value="plasticos">Pl√°sticos</option>
                <option value="papeleria">Papeler√≠a</option>
                <option value="lacteos">L√°cteos</option>
                <option value="ferreteria">Ferreter√≠a</option>
                <option value="agropecuaria">Agropecuaria</option>
                <option value="frigorifico">Frigor√≠fico</option>
                <option value="pescaderia">Pescader√≠a</option>
                <option value="repuesto">Repuesto</option>
                <option value="confiteria">Confiter√≠a</option>
                <option value="ropa">Ropa</option>
                <option value="calzados">Calzados</option>
                <option value="charcuteria">Charcuter√≠a</option>
                <option value="carnes">Carnes</option>
                <option value="aseo_personal">Aseo Personal</option>
                <option value="limpieza">Productos de Limpieza</option>
                <option value="verduras">Verduras</option>
                <option value="frutas">Frutas</option>
                <option value="hortalizas">Hortalizas</option>
                <option value="ali√±os">Ali√±os</option>
                <option value="otros">Otros</option>
            </select>
        </section>

        <section>
            <h3>Precio de Venta</h3>
            <input type="number" id="ganancia" placeholder="Porcentaje de ganancia" step="any" required />
            <input type="number" id="unidadesPorCaja" placeholder="Unidades que trae la caja" step="any" required />
            <input type="number" id="unidadesExistentes" placeholder="Unidades existentes" step="any" required />
            <button onclick="calcularPrecioVenta()">Calcular Precio de Venta</button>
            <p id="precioUnitario">Precio unitario: </p>
        </section>

        <button onclick="guardarProducto()">Guardar Producto</button>
    </div>

    <div id="listaProductos">
        <div class="ganancia-total-container">
            <div class="ganancia-total">
                <span>Ganancia total estimada:</span>
                <span id="gananciaTotalUSD">$0.00</span>
                <span id="gananciaTotalBS">/ Bs 0.00</span>
            </div>
        </div>

        <input type="text" id="buscar" placeholder="Buscar producto" />
        <button onclick="buscarProducto()">Buscar</button>

        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Descripci√≥n</th>
                    <th>C√≥digo Barras</th>
                    <th>Existencias</th>
                    <th>Ajustar Inventario</th>
                    <th>Precio Unitario ($)</th>
                    <th>Precio Unitario (Bs)</th>
                    <th>Ganancia (%)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="action-buttons">
            <button onclick="generarReporteDiario()" class="generar-pdf">üìä Reporte Diario</button>
            <button onclick="mostrarListaCostos()" class="lista-costos">üí∞ Lista de Costos</button>
            <button onclick="mostrarOpcionesPDF()" class="generar-pdf-categoria">üìÅ PDF por Categor√≠a</button>
            <button onclick="generarEtiquetasAnaqueles()" class="generar-etiquetas">üè∑Ô∏è Etiquetas Anaqueles</button>
        </div>

        <div id="listaCostosContainer" style="display: none;">
            <div class="costos-header">
                <h3>Lista de Costos de Productos</h3>
                <div class="total-invertido-container">
                    <div class="total-invertido">
                        <strong>Total invertido:</strong>
                        <span id="totalInvertidoUSD">X USD</span>
                        <span id="totalInvertidoBS">/ X Bs</span>
                    </div>
                </div>
                <div>
                    <input type="text" id="buscarCostos" placeholder="Buscar en lista de costos" style="display:none" oninput="filtrarListaCostos()" />
                    <button onclick="generarPDFCostos()" class="generar-pdf-costos">Convertir a PDF</button>
                </div>
            </div>
            <ul id="listaCostos"></ul>
        </div>
    </div>

    <!-- Modales (sin cambios) -->
    <div id="modalCategorias" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalCategorias()">&times;</span>
            <h3>Generar PDF por Categor√≠a</h3>
            <div class="categorias-lista" id="categoriasLista"></div>
        </div>
    </div>

    <div id="modalEtiquetas" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalEtiquetas()">&times;</span>
            <h3>Generar Etiquetas para Anaqueles</h3>
            <div class="selector-moneda-etiquetas">
                <label>Mostrar precios en:</label>
                <select id="monedaEtiquetas" onchange="actualizarMonedaEtiquetas()">
                    <option value="VES">Bol√≠vares (VES)</option>
                    <option value="USD">D√≥lares (USD)</option>
                </select>
            </div>
            <div class="categorias-lista" id="categoriasListaEtiquetas"></div>
        </div>
    </div>

    <div class="carrito-ventas">
        <h2>Carrito de Ventas</h2>
        <div class="carrito-header">
            <div class="scanner-input">
                <input type="text" id="codigoBarrasInput" placeholder="Escanea o ingresa c√≥digo/nombre" />
                <button onclick="agregarPorCodigoBarras()">Agregar Producto</button>
                <div id="sugerencias" class="sugerencias-lista" aria-live="polite"></div>
            </div>
            <div class="scanner-status" id="scannerStatus">Esperando escaneo...</div>
            <div class="carrito-totales">
                <div class="carrito-total" id="totalCarritoBs">Total: Bs 0,00</div>
                <div class="carrito-total" id="totalCarritoDolares">Total: $ 0,00</div>
            </div>
        </div>
        <table class="carrito-table">
            <thead><tr><th>Producto</th><th>Precio Unitario (Bs)</th><th>Cantidad</th><th>Unidad</th><th>Subtotal (Bs)</th><th>Acciones</th></tr></thead>
            <tbody id="carritoBody"></tbody>
        </table>
        <div class="finalizar-venta"><button id="finalizarVenta" onclick="finalizarVenta()">Finalizar venta</button></div>
    </div>

    <div id="modalPago" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalPago()">&times;</span>
            <h3>Seleccionar M√©todo de Pago</h3>
            <div class="resumen-venta">
                <h4>Resumen de Venta</h4>
                <p id="resumenTotalBs">Total: Bs 0,00</p>
                <p id="resumenTotalDolares">Total: $ 0,00</p>
            </div>
            <div class="metodos-pago" id="metodosPagoLista"></div>
            <div id="detallesPago" style="display: none; margin-top: 20px;">
                <h4>Detalles del Pago</h4>
                <div id="camposPago"></div>
                <div id="mensajePago" class="mensaje-pago" style="display: none;"></div>
                <div class="modal-buttons">
                    <button onclick="confirmarMetodoPago()">Confirmar Pago</button>
                    <button onclick="cancelarPago()" class="btn-cancelar">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="floating-nav">
        <button class="go-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">‚Üë</button>
        <button class="go-bottom" onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})">‚Üì</button>
    </div>

    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <div id="modalClave" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalClave()">&times;</span>
            <h3>Clave de Seguridad Requerida</h3>
            <p>Para editar productos, ingrese la clave de seguridad:</p>
            <input type="password" id="claveSeguridad" placeholder="Ingrese la clave" class="input-movil" />
            <div class="modal-buttons" style="margin-top: 15px;">
                <button onclick="verificarClave()">Verificar Clave</button>
                <button onclick="cerrarModalClave()" class="btn-cancelar">Cancelar</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">Si olvid√≥ la clave actual, contacte al administrador del sistema.</p>
        </div>
    </div>
  
    <div id="modalCambiarClave" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalCambiarClave()">&times;</span>
            <h3>Cambiar Clave de Seguridad</h3>
            <div class="campo-pago"><label>Clave actual:</label><input type="password" id="claveActual" placeholder="Ingrese clave actual" class="input-movil" /></div>
            <div class="campo-pago"><label>Nueva clave:</label><input type="password" id="nuevaClave" placeholder="Ingrese nueva clave" class="input-movil" /></div>
            <div class="campo-pago"><label>Confirmar nueva clave:</label><input type="password" id="confirmarClave" placeholder="Confirme nueva clave" class="input-movil" /></div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button onclick="cambiarClave()">Cambiar Clave</button>
                <button onclick="cerrarModalCambiarClave()" class="btn-cancelar">Cancelar</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">Si olvid√≥ la clave actual, contacte al administrador del sistema.</p>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
